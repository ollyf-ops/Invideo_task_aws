name: 'Ansible deploy'
on:
  push:
    branches:
      - dev

jobs:
  anisble-deploy:
    name: 'Ansible Deploy'
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /sunny
    steps:
      - name: 'Checkout'
        uses: actions/checkout@main
      - name: 'Check ansible connectivity'
        run: ansible testInstances -m ping
      - name: 'Executing remote ssh commands using ssh key'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script_stop: true
          script: |
            whoami
      #      - name: executing remote ssh commands using password
      #        uses: appleboy/ssh-action@master
      #        with:
      #          host: ${{ secrets.HOST }}
      #          username: ${{ secrets.USERNAME }}
      #          password: ${{ secrets.PASSWORD }}
      #          port: ${{ secrets.PORT }}
      #          script: whoami
      - name: 'Run Terraform'
        run: |
          cd /sunny/Invideo_task_aws/
          echo "To setup provisioner"
          sudo terraform init
          echo "To launch the EC2 cluster: "
          sudo terraform plan -out=aws.tfplan
          sudo terraform apply aws.tfplan --auto-approve
