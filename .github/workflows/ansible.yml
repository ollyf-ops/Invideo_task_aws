name: 'Ansible deploy'
on:
  push:
    branches:
      - dev

jobs:
  anisble-deploy:
    name: 'Ansible Deploy'
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /sunny
    steps:
      - name: 'Checkout'
        uses: actions/checkout@main

      - name: Configure SSH
        run: |
          cat >>~/.ssh/config <<END
          Host rd_test
            HostName $HOST
            User $USERNAME
            IdentityFile  ~/.ssh/$KEY
            StrictHostKeyChecking no
          END
          chmod 600 ~/.ssh/config
        env:
          USERNAME: ${{ secrets.USERNAME }}
          KEY: ${{ secrets.KEY }}
          HOST: ${{ secrets.HOST }}
          PASSWORD: ${{ secrets.PASSWORD }}

      - name: 'Check ansible connectivity'
        run: ssh rd_test 'sudo ansible testInstances -m ping'

      - name: 'Run Terraform'
        run: |
          ssh rd_test
          cd /home/${{ secrets.USERNAME }}/
          mkdir -p sunny
          cd /home/${{ secrets.USERNAME }}/sunny/
          git clone https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_PASSWORD }}@github.com/${{ secrets.GIT_ACCOUNT }}/$CI_REPOSITORY_NAME.git && \
          git checkout $CI_REPOSITORY_NAME && \
          git status && /n/n
          git diff && /n/n
          git branch && " \n Current path of working dir is " pwd && \
          cd /home/${{ secrets.USERNAME }}/sunny/$CI_REPOSITORY_NAME/
          echo "To setup provisioner"
          sudo terraform init
          echo "To launch the EC2 cluster: "
          sudo terraform plan -out=aws.tfplan
          sudo terraform apply aws.tfplan --auto-approve